<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>価格比較ツール - 価格.com vs Amazon</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* --- カスタムスタイル --- */
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 30px;
            margin-bottom: 30px;
        }
        .card-header h1 {
            font-size: 1.75rem;
            margin-bottom: 0;
        }
        .form-group label {
            font-weight: bold;
        }
        .maker-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            padding: 10px;
            border-radius: .25rem;
        }
        .price-plus {
            color: #198754; /* Bootstrap success color */
            font-weight: bold;
        }
        .price-minus {
            color: #dc3545; /* Bootstrap danger color */
            font-weight: bold;
        }
        /* --- ボタンのローディング表示スタイル --- */
        .btn-submit .spinner-border {
            display: none;
        }
        .btn-submit.loading .spinner-border {
            display: inline-block; /* Bootstrapのスピナーを利用 */
        }
        .btn-submit.loading .btn-text {
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card shadow-sm">
            <div class="card-header">
                <h1>価格比較ツール <small class="text-muted fs-6">(価格.com vs Amazon)</small></h1>
            </div>
            <div class="card-body">
                <form id="searchForm" action="/" method="post">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="category_select" class="form-label">カテゴリ</label>
                            <select name="category_keyword" id="category_select" class="form-select" required>
                                <option value="">選択してください</option>
                                <optgroup label="PCパーツ">
                                    {% for category in pc_parts_categories %}
                                        <option value="{{ category }}" {% if category_name == category %}selected{% endif %}>{{ category }}</option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="PC周辺機器">
                                    {% for category in peripherals_categories %}
                                        <option value="{{ category }}" {% if category_name == category %}selected{% endif %}>{{ category }}</option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                        </div>

                        <div class="col-md-8">
                            <label class="form-label">メーカー (複数選択可)</label>
                            <div class="maker-group" id="maker-group-container">
                                <!-- JavaScriptによってメーカーがここに表示されます -->
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="filter_keyword" class="form-label">絞り込みキーワード</label>
                            <input type="text" id="filter_keyword" name="filter_keyword" class="form-control" placeholder="(任意)" value="{{ filter_keyword or '' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="limit" class="form-label">調査件数</label>
                            <input type="number" id="limit" name="limit" class="form-control" min="1" max="50" value="{{ limit or 10 }}">
                        </div>
                        <div class="col-md-2">
                            <label for="profit_margin" class="form-label">利益率(%)</label>
                            <input type="number" id="profit_margin" name="profit_margin" class="form-control" min="0" value="{{ profit_margin or 15 }}">
                        </div>
                        <div class="col-md-2">
                            <label for="sort" class="form-label">並び順</label>
                            <select name="sort" id="sort" class="form-select">
                                <option value="price_asc" {% if selected_sort == 'price_asc' %}selected{% endif %}>価格の安い順</option>
                                <option value="saledate_desc" {% if selected_sort == 'saledate_desc' %}selected{% endif %}>発売日の新しい順</option>
                                <option value="ranking_asc" {% if selected_sort == 'ranking_asc' %}selected{% endif %}>売れ筋ランキング順</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-grid">
                            <button type="submit" id="searchButton" class="btn btn-primary btn-submit">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span class="btn-text">比較開始</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm mt-4">
            <div class="card-header">
                <h2 class="h5 mb-0">
                    {% if category_name %}
                        「{{ category_name }}」の比較結果
                    {% else %}
                        比較結果
                    {% endif %}
                </h2>
            </div>
            <div class="card-body" id="result-area">
                {% if results %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 45%;">商品名</th>
                                    <th>価格.com (円)</th>
                                    <th>Amazon (円)</th>
                                    <th>価格差 (円)</th>
                                    <th>利益率 (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in results %}
                                <tr>
                                    <td><a href="{{ item.url }}" target="_blank" title="{{ item.name }}">{{ item.name }}</a></td>
                                    <td><a href="{{ item.url }}" target="_blank">{{ "{:,.0f}".format(item.price) if item.price is not none else 'N/A' }}</a></td>
                                    <td><a href="{{ item.amazon_url }}" target="_blank">{{ "{:,.0f}".format(item.amazon_price) if item.amazon_price is not none else 'N/A' }}</a></td>
                                    <td>
                                        {% if item.price_difference is not none %}
                                            <span class="{{ 'price-plus' if item.price_difference > 0 else 'price-minus' }}">
                                                {{ "{:+,}".format(item.price_difference) }}
                                            </span>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.profit_margin is not none %}
                                            <span class="{{ 'price-plus' if item.profit_margin > 0 else 'price-minus' }}">
                                                {{ "%.1f" | format(item.profit_margin) }}%
                                            </span>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% elif request.method == 'POST' %}
                    <p class="text-center text-muted">該当する商品は見つかりませんでした。</p>
                {% else %}
                    <p class="text-center text-muted">調査したいカテゴリを選択して、「比較開始」ボタンを押してください。</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // サーバーから渡されたデータをJavaScriptの変数として受け取る
        const makersData = {{ makers_by_category_json | safe }};
        const initialSelectedMakers = {{ selected_makers | tojson }};

        // 必要なHTML要素を取得
        const categorySelect = document.getElementById('category_select');
        const makerContainer = document.getElementById('maker-group-container');

        // メーカーのチェックボックスを更新する関数
        function renderMakers() {
            const selectedCategory = categorySelect.value;
            const makers = makersData[selectedCategory] || [];

            // コンテナを空にする
            makerContainer.innerHTML = '';

            // 表示すべきメーカーがない場合はメッセージを表示
            if (makers.length === 0 && selectedCategory) {
                makerContainer.innerHTML = '<p class="text-muted small">このカテゴリのメーカーはありません。</p>';
                return;
            }

            // メーカーリストに基づいてチェックボックスを作成
            makers.forEach(maker => {
                const isChecked = initialSelectedMakers.includes(maker);
                const div = document.createElement('div');
                div.classList.add('form-check', 'form-check-inline');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'makers';
                checkbox.value = maker;
                checkbox.checked = isChecked;
                checkbox.classList.add('form-check-input');
                checkbox.id = `maker-${maker}`;

                const label = document.createElement('label');
                label.classList.add('form-check-label');
                label.setAttribute('for', `maker-${maker}`);
                label.textContent = maker;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                makerContainer.appendChild(div);
            });
        }

        // イベントリスナーを設定
        categorySelect.addEventListener('change', renderMakers);
        document.addEventListener('DOMContentLoaded', renderMakers);

        // --- フォーム送信時の処理 ---
        const searchForm = document.getElementById('searchForm');
        const searchButton = document.getElementById('searchButton');

        searchForm.addEventListener('submit', function() {
            searchButton.disabled = true;
            searchButton.classList.add('loading');
        });
    </script>
</body>
</html>